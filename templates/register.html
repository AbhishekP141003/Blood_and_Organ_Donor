{% extends "base.html" %}

{% block title %}Register as Donor - CampusDonor{% endblock %}

{% block extra_styles %}
<style>
  .form-section {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px dashed var(--border-color);
  }

  .input-group {
    display: flex;
    gap: 0.5rem;
  }

  .input-group input {
    flex: 1;
  }

  .btn-otp {
    background: var(--text-secondary);
    color: white;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    white-space: nowrap;
  }

  .btn-otp:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .field-help {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card fade-in" style="max-width: 900px; margin: 2rem auto;">
    <div class="text-center mb-4">
      <h1 style="font-size: 1.75rem; margin-bottom: 0.5rem;">‚ú® Register as Donor</h1>
      <p class="text-muted">Join the life-saving community</p>
    </div>

    {% if error %}
    <div class="alert alert-error">
      ‚ö†Ô∏è {{ error }}
    </div>
    {% endif %}

    <form method="POST" action="/register" id="regForm">
      <!-- Personal Information -->
      <div class="grid grid-2 gap-3 mb-3">
        <div>
          <label for="name">Full Name <span class="text-danger">*</span></label>
          <input type="text" id="name" name="name" placeholder="John Doe" required>
        </div>
        <div>
          <label for="email">Email (optional)</label>
          <input type="email" id="email" name="email" placeholder="you@example.com">
        </div>
      </div>

      <!-- Phone Verification -->
      <div class="grid grid-2 gap-3 mb-3">
        <div>
          <label for="phone">Phone Verification <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="text" id="phone" name="phone" placeholder="+919876543210" required>
            <button type="button" class="btn-otp" id="getOtpBtn">Get OTP</button>
          </div>
          <div class="field-help" id="otpStatus">Enter phone and click Get OTP</div>
        </div>
        <div>
          <label for="otp">Enter OTP Code <span class="text-danger">*</span></label>
          <input type="text" id="otp" name="otp" placeholder="xxxx" maxlength="4" required disabled>
        </div>
      </div>

      <div class="mb-3">
        <label for="area">Address / Campus Area</label>
        <input type="text" id="area" name="area" placeholder="North Campus, Block A">
      </div>

      <!-- Donor Type -->
      <div class="mb-3">
        <label for="donorType">Register as <span class="text-danger">*</span></label>
        <select id="donorType" name="donor_type" required>
          <option value="">Select type</option>
          <option value="blood">Blood Donor</option>
          <option value="organ">Organ Donor</option>
          <option value="both">Both (Blood & Organ)</option>
        </select>
      </div>

      <!-- Blood Donor Fields -->
      <div id="bloodBlock" class="form-section" style="display: none;">
        <h4 style="margin-bottom: 1rem; color: var(--accent-red);">ü©∏ Blood Donation Details</h4>

        <div class="grid grid-2 gap-3">
          <div>
            <label for="bloodGroup">Blood Group <span class="text-danger">*</span></label>
            <select id="bloodGroup" name="blood_group">
              <option value="">Select blood group</option>
              <option>A+</option>
              <option>A-</option>
              <option>B+</option>
              <option>B-</option>
              <option>AB+</option>
              <option>AB-</option>
              <option>O+</option>
              <option>O-</option>
            </select>
          </div>
          <div>
            <label for="bloodAvailable">Currently Available?</label>
            <select id="bloodAvailable" name="blood_available">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Organ Donor Fields -->
      <div id="organBlock" class="form-section" style="display: none;">
        <h4 style="margin-bottom: 1rem; color: #3b82f6;">ü´Ä Organ Donation Details</h4>

        <label>Organs Willing to Donate <span class="text-danger">*</span></label>
        <div
          style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 0.5rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="organs" value="kidney">
            <span style="font-weight: normal;">Kidney</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="organs" value="liver">
            <span style="font-weight: normal;">Liver</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="organs" value="heart">
            <span style="font-weight: normal;">Heart</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="organs" value="lungs">
            <span style="font-weight: normal;">Lungs</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="organs" value="cornea">
            <span style="font-weight: normal;">Cornea</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="organs" value="pancreas">
            <span style="font-weight: normal;">Pancreas</span>
          </label>
        </div>

        <div class="mt-2">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="consent">
            <span style="font-weight: normal;">I hereby consent to be an organ donor</span>
          </label>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">üíæ Submit Registration</button>
        <button type="reset" class="btn btn-outline">Reset</button>
        <a href="/" class="btn btn-outline">‚Üê Home</a>
      </div>
    </form>
  </div>
</div>

<script>
  const el = id => document.getElementById(id);

  // OTP Logic
  const otpBtn = el('getOtpBtn');
  const otpInput = el('otp');
  const phoneInput = el('phone');
  const otpStatus = el('otpStatus');

  otpBtn.addEventListener('click', async () => {
    const phone = phoneInput.value.trim();
    if (phone.length < 8) {
      alert('Please enter a valid phone number');
      return;
    }

    otpBtn.disabled = true;
    otpStatus.textContent = 'Requesting OTP...';
    otpStatus.className = 'field-help';

    try {
      const res = await fetch('/send_otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phone })
      });
      const data = await res.json();

      if (data.success) {
        otpStatus.textContent = '‚úÖ OTP Sent! Check server console.';
        otpStatus.className = 'field-help text-success';
        otpInput.disabled = false;
        otpInput.focus();
      } else {
        otpStatus.textContent = '‚ùå Error: ' + data.message;
        otpStatus.className = 'field-help text-danger';
        otpBtn.disabled = false;
      }
    } catch (e) {
      console.error(e);
      otpStatus.textContent = 'Network Error';
      otpStatus.className = 'field-help text-danger';
      otpBtn.disabled = false;
    }
  });

  // Donor Type Logic
  el('donorType').addEventListener('change', (e) => {
    const v = e.target.value;
    const isBlood = (v === 'blood' || v === 'both');
    const isOrgan = (v === 'organ' || v === 'both');

    el('bloodBlock').style.display = isBlood ? 'block' : 'none';
    el('organBlock').style.display = isOrgan ? 'block' : 'none';

    el('bloodGroup').required = isBlood;
    el('consent').required = isOrgan;
  });
</script>
{% endblock %}