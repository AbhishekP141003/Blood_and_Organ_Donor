{% extends "base.html" %}

{% block title %}Register as Blood Donor - CampusBloodDonor{% endblock %}

{% block extra_styles %}
<style>
  .input-group {
    display: flex;
    gap: 0.5rem;
  }

  .input-group input {
    flex: 1;
  }

  .btn-otp {
    background: var(--text-secondary);
    color: white;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    white-space: nowrap;
  }

  .btn-otp:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .field-help {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card fade-in" style="max-width: 700px; margin: 2rem auto;">
    <div class="text-center mb-4">
      <h1 style="font-size: 1.75rem; margin-bottom: 0.5rem;">‚ú® Register as Blood Donor</h1>
      <p class="text-muted">Join the life-saving community</p>
    </div>

    {% if error %}
    <div class="alert alert-error">
      ‚ö†Ô∏è {{ error }}
    </div>
    {% endif %}

    <form method="POST" action="/register">
      <!-- Personal Information -->
      <div class="grid grid-2 gap-3 mb-3">
        <div>
          <label for="name">Full Name <span class="text-danger">*</span></label>
          <input type="text" id="name" name="name" placeholder="John Doe" required>
        </div>
        <div>
          <label for="phone">Phone Number <span class="text-danger">*</span></label>
          <input type="tel" id="phone" name="phone" placeholder="+919876543210" required>
        </div>
      </div>

      <!-- Email Verification -->
      <div class="grid grid-2 gap-3 mb-3">
        <div>
          <label for="email">Email Address (OTP Verification) <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
            <button type="button" class="btn-otp" id="getOtpBtn">Get OTP</button>
          </div>
          <div class="field-help" id="otpStatus">Enter email and click Get OTP</div>
        </div>
        <div>
          <label for="otp">Enter OTP Code <span class="text-danger">*</span></label>
          <input type="text" id="otp" name="otp" placeholder="xxxx" maxlength="4" required disabled>
        </div>
      </div>

      <div class="mb-3">
        <label for="area">Address / Campus Area</label>
        <input type="text" id="area" name="area" placeholder="North Campus, Block A">
      </div>

      <!-- Blood Group -->
      <div class="grid grid-2 gap-3 mb-3">
        <div>
          <label for="bloodGroup">Blood Group <span class="text-danger">*</span></label>
          <select id="bloodGroup" name="blood_group" required>
            <option value="">Select blood group</option>
            <option>A+</option>
            <option>A-</option>
            <option>B+</option>
            <option>B-</option>
            <option>AB+</option>
            <option>AB-</option>
            <option>O+</option>
            <option>O-</option>
          </select>
        </div>
        <div>
          <label for="bloodAvailable">Currently Available?</label>
          <select id="bloodAvailable" name="blood_available">
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">üíæ Submit Registration</button>
        <button type="reset" class="btn btn-outline">Reset</button>
        <a href="/" class="btn btn-outline">‚Üê Home</a>
      </div>
    </form>
  </div>
</div>

<script>
  const el = id => document.getElementById(id);

  // OTP Logic
  const otpBtn = el('getOtpBtn');
  const otpInput = el('otp');
  const emailInput = el('email');
  const nameInput = el('name');
  const otpStatus = el('otpStatus');

  otpBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const name = nameInput.value.trim();

    if (!email || !email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }

    otpBtn.disabled = true;
    otpBtn.textContent = 'Sending...';
    otpStatus.textContent = 'Sending OTP to your email...';
    otpStatus.className = 'field-help';

    try {
      const res = await fetch('/send_otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, name: name })
      });
      const data = await res.json();

      if (data.success) {
        otpStatus.textContent = `‚úÖ ${data.message} Check spam or inbox`;
        otpStatus.className = 'field-help text-success';
        otpInput.disabled = false;
        otpInput.focus();
        otpBtn.textContent = 'Resend OTP';
        setTimeout(() => { otpBtn.disabled = false; }, 30000); // Allow resend after 30s
      } else {
        otpStatus.textContent = '‚ùå Error: ' + data.message;
        otpStatus.className = 'field-help text-danger';
        otpBtn.disabled = false;
        otpBtn.textContent = 'Get OTP';
      }
    } catch (e) {
      console.error(e);
      otpStatus.textContent = 'Network Error';
      otpStatus.className = 'field-help text-danger';
      otpBtn.disabled = false;
      otpBtn.textContent = 'Get OTP';
    }
  });
</script>
{% endblock %}