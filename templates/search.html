{% extends "base.html" %}

{% block title %}Search Blood Donors - CampusBloodDonor{% endblock %}

{% block extra_styles %}
<style>
  .security-box {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border: 1px solid #fcd34d;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  [data-theme="dark"] .security-box {
    background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(234, 179, 8, 0.2) 100%);
    border-color: rgba(234, 179, 8, 0.3);
  }

  .input-group {
    display: flex;
  }

  .input-group input {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  }

  .btn-otp {
    background: var(--text-secondary);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    white-space: nowrap;
  }

  .donor-card {
    background: var(--card-bg);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.2s;
  }

  .donor-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px var(--card-shadow);
  }

  .badge-blood {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    background: #fee2e2;
    color: #991b1b;
  }

  [data-theme="dark"] .badge-blood {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
  }

  .phone-mask {
    font-family: 'Courier New', monospace;
    background: var(--bg-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-weight: 600;
  }

  .btn-call {
    background: var(--accent-green);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    font-weight: 600;
  }

  .btn-call:hover {
    background: #15803d;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card fade-in">
    <h1 style="font-size: 1.75rem; margin-bottom: 0.5rem;">üîç Search Blood Donors</h1>
    <p class="text-muted mb-4">Find blood donors and get connected instantly</p>

    {% if error_message %}
    <div class="alert alert-error">
      ‚ö†Ô∏è {{ error_message }}
    </div>
    {% endif %}

    <form method="GET" action="/search">
      <!-- Security Verification -->
      <div class="security-box">
        <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">üîí Identity Verification</h4>
        <p style="font-size: 0.9rem; color: #78350f; margin-bottom: 1rem;">
          Provide your details and verify your phone to search donors
        </p>

        <div class="grid grid-2 gap-3">
          <div>
            <label>Your Name</label>
            <input type="text" name="seeker_name" required value="{{ request.args.get('seeker_name', '') }}"
              placeholder="Your full name">
          </div>
          <div>
            <label>Student / Staff ID</label>
            <input type="text" name="seeker_id" required value="{{ request.args.get('seeker_id', '') }}"
              placeholder="e.g. STU-2024">
          </div>
          <div>
            <label>Mobile Number</label>
            <div class="input-group">
              <input type="text" id="phoneInput" name="seeker_phone" required
                value="{{ request.args.get('seeker_phone', '') }}" placeholder="Your phone">
              <button type="button" class="btn-otp" id="sendOtpBtn">Get OTP</button>
            </div>
            <small id="otpStatus" class="text-muted"></small>
          </div>
          <div>
            <label>Enter OTP Code</label>
            <input type="text" name="otp" id="otpInput" placeholder="xxxx" maxlength="4" required disabled>
          </div>
        </div>
      </div>

      <!-- Search Filters -->
      <div class="grid grid-2 gap-3 mb-3">
        <div>
          <label>Filter by Area (Optional)</label>
          <input type="text" name="area" placeholder="e.g. North Campus" value="{{ request.args.get('area', '') }}">
        </div>

        <div>
          <label>Blood Group</label>
          <select name="bg">
            <option value="">Any</option>
            {% for bg in ['A+','A-','B+','B-','AB+','AB-','O+','O-'] %}
            <option value="{{ bg }}" {% if request.args.get('bg')==bg %}selected{% endif %}>
              {{ bg }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <button type="submit" class="btn btn-primary" style="width: 100%;">
        üîç Verify & Search Donors
      </button>
    </form>

    <!-- Search Results -->
    {% if search_performed %}
    <hr style="border: none; height: 1px; background: var(--border-color); margin: 2rem 0;">

    <h3 class="mb-3">Search Results ({{ donors|length }} found)</h3>

    {% if donors|length == 0 %}
    <div class="text-center text-muted" style="padding: 3rem;">
      No donors found matching your criteria. Try adjusting your filters.
    </div>
    {% else %}
    {% for donor in donors %}
    <div class="donor-card">
      <div class="flex" style="justify-content: space-between; align-items: flex-start; gap: 1rem;">
        <div style="flex: 1;">
          <h4 style="margin-bottom: 0.5rem; font-size: 1.25rem;">{{ donor.name }}</h4>
          <p class="text-muted" style="margin-bottom: 0.75rem;">
            üìç {{ donor.area or 'Location not specified' }}
          </p>
          <div>
            <span class="badge-blood">ü©∏ Blood Group: {{ donor.blood_group }}</span>
          </div>
        </div>

        <div style="text-align: right;" id="contact-{{ donor.id }}">
          <div class="phone-mask">******{{ donor.phone[-4:] }}</div>
          <button class="btn btn-primary" style="padding: 0.5rem 1rem; margin-top: 0.5rem; font-size: 0.9rem;"
            onclick="revealContact('{{ donor.id }}', '{{ donor.phone }}', '{{ donor.email }}')">
            Reveal Contact
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endif %}
    {% endif %}
  </div>
</div>

<script>
  // OTP Logic
  const sendBtn = document.getElementById('sendOtpBtn');
  const phoneIn = document.getElementById('phoneInput');
  const otpIn = document.getElementById('otpInput');
  const status = document.getElementById('otpStatus');

  sendBtn.addEventListener('click', async () => {
    const phone = phoneIn.value.trim();
    if (!phone || phone.length < 8) {
      alert('Enter valid phone number');
      return;
    }

    sendBtn.disabled = true;
    status.textContent = 'Requesting OTP...';
    status.className = 'text-muted';

    try {
      const res = await fetch('/send_otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phone })
      });
      const data = await res.json();

      if (data.success) {
        status.textContent = '‚úÖ OTP Sent! Check Server Console.';
        status.className = 'text-success';
        otpIn.disabled = false;
        otpIn.focus();
      } else {
        status.textContent = '‚ùå Error sending OTP.';
        status.className = 'text-danger';
      }
    } catch (e) {
      console.error(e);
      status.textContent = 'Network error';
      status.className = 'text-danger';
    }

    sendBtn.disabled = false;
  });

  // Reveal Contact
  function revealContact(id, phone, email) {
    const container = document.getElementById('contact-' + id);
    container.innerHTML = `
            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">${phone}</div>
            <a href="tel:${phone}" class="btn-call">üìû Call Now</a>
            ${email ? `<div class="text-muted" style="font-size: 0.9rem; margin-top: 0.5rem;">${email}</div>` : ''}
        `;
  }
</script>
{% endblock %}